<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=sfd10dmdar&amp;submodules=geocoder"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
  </head>
  <body>
    <div style="margin-top:20px; margin-bottom:10px; font-weight:bold;">
      약국 지도
    </div>
    <div id="map" style="width:100%; height:600px;">

    </div>
  </body>
  <script>
    $(document).ready(async function(){
      let XY = await getLocation();
      // alert("위도" + XY.lat);
      // alert("경도" + XY.lng);
      await naver.maps.Service.reverseGeocode({
        location: new naver.maps.LatLng(XY.lat, XY.lng)
      },function(status, response) {
        let result = response.result;
        let items = result.items;
        //items[0].addrdetail.sido; // 시도
        //items[0].addrdetail.sigugun; // 시구군
        let sido_arr = items[0].addrdetail.sido.split(" ");
        let gubun_arr = items[0].addrdetail.sigugun.split(" ");

        let sido = "";
        let gubun = "";
        if(sido_arr.length == 1) {
          sido = sido_arr[0];
          gugun = gubun_arr[0];
        }
        else if(sido_arr.length > 1) {
          sido = sido_arr[0];
          gugun = sido_arr[1];
        }
        console.log(sido);
        console.log(gugun);

        $.ajax({
          url: "/pharmach_list",
          type: "GET",
          cache: false,
          dataType: "json",
          data: {"Q0": sido, "Q1": gugun, "QT": "", "ORD": "", "pageNo": "1", "numOfRows":"1000"},
          success: function(data) {
            console.log(data);
            //지도를 삽입할 HTML 요소 또는 HTML 요소의 id를 지정합니다.
            let mapDiv = document.getElementById('map'); // 'map'으로 선언해도 동일
            //옵션 없이 지도 객체를 생성하면 서울 시청을 중심으로 하는 16 레벨의 지도가 생성됩니다.
            let mapOptions = {
              center: new naver.maps.LatLng(XY.lat, XY.lng),
              zoom: 13
            }
            let map = new naver.maps.Map(mapDiv, mapOptions);

            data.items.item.forEach(function(it, index) {
              let dutyName = it.dutyName; // 약국명
              let dutyAddr = it.dutyAddr; // 주소
              let dutyTel1 = it.dutyTel1; // 전화번호

              let dutyTime = "";

              let pharmach_location = new naver.maps.LatLng(it.wgs84Lat, it.wgs84Lon);

              marker = new naver.maps.Marker({
                map: map,
                position: cityhall
            });
        
              let contentString = [
                      '<div class="iw_inner">',
                      '   <h3>서울특별시청</h3>',
                      '   <p>서울특별시 중구 태평로1가 31 | 서울특별시 중구 세종대로 110 서울특별시청<br />',
                      '       <img src="'+ HOME_PATH +'/img/example/hi-seoul.jpg" width="55" height="55" alt="서울시청" class="thumb" /><br />',
                      '       02-120 | 공공,사회기관 &gt; 특별,광역시청<br />',
                      '       <a href="http://www.seoul.go.kr" target="_blank">www.seoul.go.kr/</a>',
                      '   </p>',
                      '</div>'
                  ].join('');
              
              let infowindow = new naver.maps.InfoWindow({
                  content: contentString,
                  maxWidth: 140,
                  backgroundColor: "#eee",
                  borderColor: "#2db400",
                  borderWidth: 5,
                  anchorSize: new naver.maps.Size(30, 30),
                  anchorSkew: true,
                  anchorColor: "#eee",
                  pixelOffset: new naver.maps.Point(20, -20)
              });
              
              naver.maps.Event.addListener(marker, "click", function(e) {
                  if (infowindow.getMap()) {
                      infowindow.close();
                  } else {
                      infowindow.open(map, marker);
                  }
              });
            });
          },
          error: function(request, status, error) {

          }
        });
      });
    });

    async function getLocation() {
      let XY = new Object();
      if(navigator.geolocation) {
        
        let promise = new Promise((resolve, rejected) => {
          navigator.geolocation.getCurrentPosition((position) => {
            resolve(position);
          });
        });

        let position = await promise;
        // position.coords.latitude 위도
        // position.coords.longitude 경도
        XY.lat = position.coords.latitude;
        XY.lng = position.coords.longitude;
      }
      return XY;
    }
  </script>
</html>